# Core libraries (install them manually beforehand if needed)
# install.packages(c("tidycensus", "sf", "dplyr", "readr", "zoo", "lubridate", "ggplot2"))
library(tidycensus)
library(sf)
library(dplyr)
library(readr)
library(zoo)
library(lubridate)
library(ggplot2)
options(scipen = 999, dplyr.summarise.inform = FALSE)
# Core libraries (install them manually beforehand if needed)
# install.packages(c("tidycensus", "sf", "dplyr", "readr", "zoo", "lubridate", "ggplot2"))
library(tidycensus)
library(sf)
library(dplyr)
library(readr)
library(zoo)
library(lubridate)
library(ggplot2)
options(scipen = 999, dplyr.summarise.inform = FALSE)
# NOTE: Make sure you have set your Census API key once using:
# tidycensus::census_api_key("YOUR_KEY_HERE", install = TRUE)
philly_tracts <- get_acs(
geography = "tract",
state = "PA",
county = "Philadelphia",
variables = "B01001_001",  # total population, used just to get geometry
year = 2022,
geometry = TRUE
)
philly_tracts_sf <- philly_tracts %>%
select(GEOID, geometry)
philly_tracts_sf
# ---- Step 2: ACS Data (Socioeconomic & Housing + Education) ----
acs_vars <- c(
# Demographics
total_pop          = "B01001_001",
white_pop          = "B02001_002",
black_pop          = "B02001_003",
asian_pop          = "B02001_005",
hispanic_pop       = "B03003_003",
# Economic indicators
median_income      = "B19013_001",
poverty_total      = "B17001_001",
poverty_below      = "B17001_002",
unemployment_total = "B23025_002",
unemployment_unemployed = "B23025_005",
# Housing & tenure
total_housing_units = "B25001_001",
renter_occupied     = "B25003_003",
median_rent         = "B25064_001",
median_home_value   = "B25077_001",
# Rent burden distribution
rent_30_to_35_pct   = "B25070_007",
rent_35_to_40_pct   = "B25070_008",
rent_40_to_50_pct   = "B25070_009",
rent_50_plus_pct    = "B25070_010",
# Housing age & vacancy
median_year_built   = "B25037_001",
vacant_units        = "B25002_003",
# Education - Less than high school (B15003 table)
edu_total           = "B15003_001",
less_than_hs_2      = "B15003_002",
less_than_hs_3      = "B15003_003",
less_than_hs_4      = "B15003_004",
less_than_hs_5      = "B15003_005",
less_than_hs_6      = "B15003_006",
less_than_hs_7      = "B15003_007",
less_than_hs_8      = "B15003_008",
less_than_hs_9      = "B15003_009",
less_than_hs_10     = "B15003_010",
less_than_hs_11     = "B15003_011",
less_than_hs_12     = "B15003_012",
less_than_hs_13     = "B15003_013",
less_than_hs_14     = "B15003_014",
less_than_hs_15     = "B15003_015",
less_than_hs_16     = "B15003_016"
)
acs_raw <- get_acs(
geography = "tract",
state = "PA",
county = "Philadelphia",
variables = acs_vars,
year = 2022,
output = "wide",
geometry = FALSE
)
acs_final <- acs_raw %>%
mutate(
# -------------------------
# Race composition
# -------------------------
pct_white     = white_popE     / total_popE * 100,
pct_black     = black_popE     / total_popE * 100,
pct_hispanic  = hispanic_popE  / total_popE * 100,
pct_asian     = asian_popE     / total_popE * 100,
# -------------------------
# Poverty & unemployment
# -------------------------
poverty_rate      = poverty_belowE / poverty_totalE * 100,
unemployment_rate = unemployment_unemployedE / unemployment_totalE * 100,
# -------------------------
# Tenure & rent burden
# -------------------------
pct_renter        = renter_occupiedE / total_housing_unitsE * 100,
rent_burdened     = rent_30_to_35_pctE + rent_35_to_40_pctE +
rent_40_to_50_pctE + rent_50_plus_pctE,
pct_rent_burdened = rent_burdened / renter_occupiedE * 100,
pct_severe_burden = rent_50_plus_pctE / renter_occupiedE * 100,
# -------------------------
# Education – Less than High School
# -------------------------
less_than_hs = less_than_hs_2E + less_than_hs_3E + less_than_hs_4E +
less_than_hs_5E + less_than_hs_6E + less_than_hs_7E +
less_than_hs_8E + less_than_hs_9E + less_than_hs_10E +
less_than_hs_11E + less_than_hs_12E + less_than_hs_13E +
less_than_hs_14E + less_than_hs_15E + less_than_hs_16E,
pct_less_than_hs = less_than_hs / edu_totalE * 100,
# -------------------------
# Housing age
# -------------------------
property_age  = 2024 - median_year_builtE
) %>%
select(
GEOID,
total_popE,
pct_white, pct_black, pct_hispanic, pct_asian,
poverty_rate, unemployment_rate,
median_incomeE, pct_renter,
pct_rent_burdened, pct_severe_burden,
pct_less_than_hs,              # <- newly added education variable
median_rentE, median_home_valueE,
property_age, vacant_unitsE
) %>%
rename(
total_pop         = total_popE,
median_income     = median_incomeE,
median_rent       = median_rentE,
median_home_value = median_home_valueE,
vacant_units      = vacant_unitsE
)
head(acs_final)
write.csv(acs_final, "acs_final.csv", row.names = FALSE)
# NOTE: This URL may need to be updated if the dataset name or schema changes.
opa_url <- "https://phl.carto.com/api/v2/sql?q=SELECT%20*%20FROM%20opa_properties_public&format=csv"
opa_raw <- read.csv(opa_url)
# NOTE: This URL may need to be updated if the dataset name or schema changes.
opa_url <- "https://phl.carto.com/api/v2/sql?q=SELECT%20*%20FROM%20opa_properties_public&format=csv"
opa_raw <- read.csv(opa_url)
library(sf)
library(dplyr)
library(readr)
library(janitor)
library(lubridate)
library(ggplot2)
library(tidyr)
tracts <- st_read("data/tl_2020_42_tract")
# 只保留 Philadelphia County（FIPS = 101）
philly_tracts <- tracts %>% filter(COUNTYFP == "101")
philly_tracts <- philly_tracts %>%
mutate(GEOID = paste0(STATEFP, COUNTYFP, TRACTCE))
opa <- read_csv("data/opa_properties_public.csv") %>% clean_names()
opa_clean <- st_read("data/property&spatial.geojson")
View(opa_clean)
opa_clean <- st_read("data/property&spatial.geojson")
names(opa_clean)
names(philly_final)
